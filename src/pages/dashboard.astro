---
import DashboardHeader from "../components/layout/DashboardHeader.astro";
import MainLayout from "../layouts/main.astro";
import { fetchAPIGET } from "../utils/fetchAPI";

const sessionToken = Astro.cookies.get("SESSION_TOKEN");
if (!sessionToken?.boolean()) {
    return Astro.redirect("/login");
}

let userName = "";
try {
    const headers = new Headers();
    headers.append("Cookie", `SESSION_TOKEN=${sessionToken.value}`);
    const res = await fetchAPIGET({
        url: "/loggedin",
        headers,
    });

    userName = res.name;
} catch {
    Astro.cookies.set("SESSION_TOKEN", "", {
        path: "/",
        httpOnly: true,
        maxAge: 0,
        secure: import.meta.env.IN_PRODUCTION === "true",
    });
    return Astro.redirect("/login");
}
---

<MainLayout description="Dashboard">
    <DashboardHeader user={userName} slot="navbar" />
    <h1 class="text-5xl">Dashboard</h1>
</MainLayout>
